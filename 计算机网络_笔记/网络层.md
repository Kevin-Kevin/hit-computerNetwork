##  网络层

> 1. ip 数据报首部格式
> 2. ip 分片
> 3. ip 选路
> 4. 四个协议 : ICMP , IGMP, IP, ARP



### IP 地址

#### IPv4 编址

每个 IP 地址长度为 32 比特, 既 4 个字节, 按点分十进制来书写,如 :  `192.168.0.1`

#### IP 地址分类

IP 地址被分为若干个固定的类, 由两个固定长度的字段组成 : 

**网络号 net-id 和 主机号 host-id**

> CIDR 的出现消除了下图的分类, 使得网络号是不固定的, 减少了路由器中路由表的规模, 后面会写到 CIDR

![image-20210312150536129](../../../Library/Application%20Support/typora-user-images/image-20210312150536129.png)

有几个特殊的 ip 地址

![image-20210312151356686](https://gitee.com/kevinzhang1999/my-picture/raw/master/uPic/image-20210312151356686-1615533236804.png)

路由器转发时根据网络号转发, 网络号一样的就属于一片区域

区域内是由用转发器或网桥连接起来的若干个局域网, 这片区域内的主机的网络号必须一致

路由器由于在两个区域的交界处就要有两个 IP 地址 , 这种主机称为多归属主机





### IP 数据报的格式

![image-20210311173837321](https://gitee.com/kevinzhang1999/my-picture/raw/master/uPic/image-20210311173837321-1615455517495.png)

各字段含义 :  

> 先讲一下分片
>
> 数据链路层协议规定了一个帧中数据字段的最大长度, 既最大传输单元 MTU ( max transfer unit )
>
> 数据报长了就要分片



1. 版本字段 : IP 协议的版本, 目前广泛使用 IPv4, 既 IP version 4

2. 首部长度 字段 :  占 4 位, 令其值为 n , 则首部长度 = n×32 (位) = n×4 (字节)

3. 区分服务 :   一般不用

4. 总长度 :  首部和数据部分之和, 单位是字节

5. 标识 : 每产生一个数据报, 计数器就加 1, 这样可以因为 MTU 分片时正确把拆分的片合起来

6. 标志 :   占 3 位, 只有后两位有意义
   - MF (more fragment) : 为 1 代表后面还有分片, 为 0 代表这是数据报分片中的最后一片
   - DF (don't fragment) : 为 1 代表不能分片, 为 0 才可以分片

7. 片偏移 :  占 13 位, 单位是 8 个字节. 代表原先此片在未分片前原分组中的起始位置, 这也说明了分片的长度一定是 8字节 的倍数

   ![image-20210311221910533](https://gitee.com/kevinzhang1999/my-picture/raw/master/uPic/image-20210311221910533-1615472350701.png)

8. 生存时间 : 8 位, TTL time to live , 数据报每经过一个路由器, 减去一段时间, 为 0 就丢弃数据报; 现在变为**跳数**, 经过一个路由器就减 1

9. 协议 :  代表数据部分使用的协议

10. 首部校验和 :  只校验首部, 采用反码算数运算求和

11. 源地址 :  本机 IP 地址

12. 目的地址 :  目的 IP 地址

13. 首部可变部分



#### IP 层转发分组的流程

路由器将局域网连接起来, 路由器 R1 可以看成既在网 1 中,又在网 2 中

路由器将收到的分组的目的 IP 地址 D 和子网掩码进行与运算, 得出目的主机的所在的网络 N

然后查询路由表, 得到下一跳的地址, 然后将分组转发给下一跳

下一跳的路由器继续上诉操作, 直到发送的指定的网络 N 中

> 路由表中不只有下图的两种信息, 还有其余信息
>
> 表中的下一跳地址是 IP 地址, 但是IP 数据报首部中没有"下一跳的 IP 地址", 实际上是转换成目的 Mac 地址 ( 使用 ARP ) 放到以太网帧的首部
>
> 分组在进行转发的时候实际上是到一个地方问下一个地方怎么走, 而不是一开始就有具体的路线
>
> 

![image-20210312180724273](https://gitee.com/kevinzhang1999/my-picture/raw/master/uPic/image-20210312180724273-1615543644441.png) 







### 划分子网



